import{getRandomArbitrary as Me,clamp as Te,checkRectCollision as ie,Point2D as se,Rect as Fe}from"./utils";export function startGame(p={}){const ne=/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor),a=p.width||640,r=p.height||640,le="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAEACAYAAAADRnAGAAACGUlEQVR42u3aSQ7CMBAEQIsn8P+/hiviAAK8zFIt5QbELiTHmfEYE3L9mZE9AAAAqAVwBQ8AAAD6THY5CgAAAKbfbPX3AQAAYBEEAADAuZrC6UUyfMEEAIBiAN8OePXnAQAAsLcmmKFPAQAAgHMbm+gbr3Sdo/LtcAAAANR6GywPAgBAM4D2JXAAABoBzBjA7AmlOx8AAEAzAOcDAADovTc4vQim6wUCABAYQG8QAADd4dPd2fRVYQAAANQG0B4HAABAawDnAwAA6AXgfAAAALpA2uMAAABwPgAAgPoAM9Ci/R4AAAD2dmqcEQIAIC/AiQGuAAYAAECcRS/a/cJXkUf2AAAAoBaA3iAAALrD+gIAAADY9baX/nwAAADNADwFAADo9YK0e5FMX/UFACA5QPSNEAAAAHKtCekmDAAAAADvBljtfgAAAGgMMGOrunvCy2uCAAAACFU6BwAAwF6AGQPa/XsAAADYB+B8AAAAtU+ItD4OAwAAAFVhAACaA0T7B44/BQAAANALwGMQAAAAADYO8If2+P31AgAAQN0SWbhFDwCAZlXgaO1xAAAA1FngnA8AACAeQPSNEAAAAM4CnC64AAAA4GzN4N9NSfgKEAAAAACszO26X8/X6BYAAAD0Anid8KcLAAAAAAAAAJBnwNEvAAAA9Jns1ygAAAAAAAAAAAAAAAAAAABAQ4COCENERERERERERBrnAa1sJuUVr3rsAAAAAElFTkSuQmCC",y=37,E=39,oe=32,ae=500,re={x:0,y:204,w:62,h:32},ce=[{x:0,y:0,w:51,h:34},{x:0,y:102,w:51,h:34}],he=[{x:0,y:137,w:50,h:33},{x:0,y:170,w:50,h:34}],ue=[{x:0,y:68,w:50,h:32},{x:0,y:34,w:50,h:32}],D=40,Ae=11*D;let A,l,b,I,h=[],S=[],_=0,o,u=[],v,x=!1,g=-1,P=0,w=0,Q=1,d=!1;class N{img;position;scale;bounds;doLogic;constructor(e,t,s){this.img=e,this.position=new se(t,s),this.scale=new se(1,1),this.bounds=new Fe(t,s,this.img.width,this.img.height),this.doLogic=!0}update(e){}_updateBounds(){this.bounds.set(this.position.x,this.position.y,~~(.5+this.img.width*this.scale.x),~~(.5+this.img.height*this.scale.y))}_drawImage(){l.drawImage(this.img,this.position.x,this.position.y)}draw(e){this._updateBounds(),this._drawImage()}}class H extends N{clipRect;constructor(e,t,s,n){super(e,s,n),this.clipRect=t,this.bounds.set(s,n,this.clipRect.w,this.clipRect.h)}update(e){}_updateBounds(){const e=~~(.5+this.clipRect.w*this.scale.x),t=~~(.5+this.clipRect.h*this.scale.y);this.bounds.set(this.position.x-e/2,this.position.y-t/2,e,t)}_drawImage(){l.save(),l.transform(this.scale.x,0,0,this.scale.y,this.position.x,this.position.y),l.drawImage(this.img,this.clipRect.x,this.clipRect.y,this.clipRect.w,this.clipRect.h,~~(.5+-this.clipRect.w*.5),~~(.5+-this.clipRect.h*.5),this.clipRect.w,this.clipRect.h),l.restore()}draw(e){super.draw(e)}}class de extends H{lives;xVel;bullets;bulletDelayAccumulator;score;constructor(){super(b,re,a/2,r-70),this.scale.set(.85,.85),this.lives=3,this.xVel=0,this.bullets=[],this.bulletDelayAccumulator=0,this.score=0}reset(){this.lives=3,this.score=0,this.position.set(a/2,r-70)}shoot(){const e=new O(this.position.x,this.position.y-this.bounds.h/2,1,1e3);this.bullets.push(e),R("shoot")}handleInput(){Y(y)?this.xVel=-175:Y(E)?this.xVel=175:this.xVel=0,K(oe)&&this.bulletDelayAccumulator>.5&&(this.shoot(),this.bulletDelayAccumulator=0)}updateBullets(e){for(let t=this.bullets.length-1;t>=0;t--){let s=this.bullets[t];s.alive?s.update(e):(this.bullets.splice(t,1),s=void 0)}}update(e){this.bulletDelayAccumulator+=e,this.position.x+=this.xVel*e,this.position.x=Te(this.position.x,this.bounds.w/2,a-this.bounds.w/2),this.updateBullets(e)}draw(e){super.draw(e);for(let t=0,s=this.bullets.length;t<s;t++){const n=this.bullets[t];n.alive&&n.draw(e)}}}class O extends N{direction;speed;alive;constructor(e,t,s,n){super(I,e,t),this.direction=s,this.speed=n,this.alive=!0}update(e){this.position.y-=this.speed*this.direction*e,this.position.y<0&&(this.alive=!1)}draw(e){super.draw(e)}}class me extends H{clipRects;onFirstState;stepDelay;stepAccumulator;doShoot;bullet;alive;constructor(e,t,s){super(b,e[0],t,s),this.clipRects=e,this.scale.set(.5,.5),this.alive=!0,this.onFirstState=!0,this.stepDelay=1,this.stepAccumulator=0,this.doShoot=!1,this.bullet=void 0}toggleFrame(){this.onFirstState=!this.onFirstState,this.clipRect=this.onFirstState?this.clipRects[0]:this.clipRects[1]}shoot(){this.bullet=new O(this.position.x,this.position.y+this.bounds.w/2,-1,500)}update(e){if(this.stepAccumulator+=e,this.stepAccumulator>=this.stepDelay){this.position.x<this.bounds.w/2+20&&g<0&&(x=!0),g===1&&this.position.x>a-this.bounds.w/2-20&&(x=!0),this.position.y>a-50&&ge();const t=Math.floor(Math.random()*(this.stepDelay+1));Me(0,1e3)<=5*(this.stepDelay+1)&&(this.doShoot=!0),this.position.x+=10*g,this.toggleFrame(),this.stepAccumulator=0}this.position.y+=P,this.bullet&&this.bullet.alive?this.bullet.update(e):this.bullet=void 0}draw(e){super.draw(e),this.bullet!==void 0&&this.bullet.alive&&this.bullet.draw(e)}}class pe{particlePool;particles;constructor(){this.particlePool=[],this.particles=[]}draw(){for(let e=this.particles.length-1;e>=0;e--){const t=this.particles[e];t.moves++,t.x+=t.xunits,t.y+=t.yunits+t.gravity*t.moves,t.life--,t.life<=0?this.particlePool.length<100?this.particlePool.push(this.particles.splice(e,1)):this.particles.splice(e,1):(l.globalAlpha=t.life/t.maxLife,l.fillStyle=t.color,l.fillRect(t.x,t.y,t.width,t.height),l.globalAlpha=1)}}createExplosion(e,t,s,n,m,f,z,J,q){for(let j=0;j<n;j++){const Le=Math.floor(Math.random()*360),Z=Math.floor(Math.random()*z/2)+z,C=Math.floor(Math.random()*q)+q/2,$=Le*Math.PI/180,ee=Math.cos($)*Z,te=Math.sin($)*Z;if(this.particlePool.length>0){const c=this.particlePool.pop();c.x=e,c.y=t,c.xunits=ee,c.yunits=te,c.life=C,c.color=s,c.width=m,c.height=f,c.gravity=J,c.moves=0,c.alpha=1,c.maxLife=C,this.particles.push(c)}else this.particles.push({x:e,y:t,xunits:ee,yunits:te,life:C,color:s,width:m,height:f,gravity:J,moves:0,alpha:1,maxLife:C})}}}function fe(){if(p.canvas)A=p.canvas;else{const i=p.selector||"#invaders",e=document.querySelector(i)||document.body;A=document.createElement("canvas"),e.appendChild(A)}A.width=a,A.height=r,l=A.getContext("2d"),G(!1),b=new Image,b.src=le,be(),window.addEventListener("resize",V),document.addEventListener("keydown",Pe),document.addEventListener("keyup",Be)}function be(){const i=Ce(2,8,e=>{e.fillStyle="white",e.fillRect(0,0,e.canvas.width,e.canvas.height)});I=new Image,I.src=i.toDataURL()}function G(i){l.imageSmoothingEnabled=i,l.mozImageSmoothingEnabled=i,l.oImageSmoothingEnabled=i,l.webkitImageSmoothingEnabled=i,l.msImageSmoothingEnabled=i}function B(){u=[],o=new de,v=new pe,L(),X()}function L(){w=0;for(let i=0,e=5*11;i<e;i++){const t=i%11,s=Math.floor(i/11);let n=[];switch(s){case 0:case 1:n=ce;break;case 2:case 3:n=he;break;case 4:n=ue;break}u.push(new me(n,a/2-Ae/2+D/2+t*D,r/3.25-s*40)),w++}}function ge(){u=[],L(),o.reset()}function we(){fe(),h=[],S=[],V()}function Y(i){return h[i]}function K(i){return!S[i]&&h[i]}function ye(i){x&&(x=!1,g=-g,P=25);for(let e=u.length-1;e>=0;e--){let t=u[e];if(!t.alive){u.splice(e,1),t=void 0,w--,w<1&&(Q++,L());return}if(t.stepDelay=(w*20-Q*10)/1e3,t.stepDelay<=.05&&(t.stepDelay=.05),t.update(i),t.doShoot){t.doShoot=!1,t.shoot();const s=String(Math.round(Math.random()*3+1));R(`fastinvader${s}`)}}P=0}function Ee(){const i=o.bullets;for(let e=0,t=i.length;e<t;e++){const s=i[e];for(let n=0,m=u.length;n<m;n++){const f=u[n];ie(s.bounds,f.bounds)&&(f.alive=s.alive=!1,R("invaderkilled"),v.createExplosion(f.position.x,f.position.y,"white",70,5,5,3,.15,50),o.score+=25)}}}function ve(){for(let i=0,e=u.length;i<e;i++){const t=u[i];if(t.bullet&&ie(t.bullet.bounds,o.bounds))if(o.lives===0)d=!1;else{R("explosion"),t.bullet.alive=!1,v.createExplosion(o.position.x,o.position.y,"green",100,8,8,6,.001,40),o.position.set(a/2,r-70),o.lives--;break}}}function xe(){Ee(),ve()}function Re(i){o.handleInput(),S=h.slice(),o.update(i),ye(i),xe()}function Ce(i,e,t){const s=document.createElement("canvas");s.width=i,s.height=e;const n=s.getContext("2d");return t(n),s}function M(i,e,t,s,n){typeof s<"u"&&(l.fillStyle=s),typeof n<"u"&&(l.font=n+"px Play"),l.fillText(i,e,t)}function T(i,e,t,s,n){const m=l.measureText(i);M(i,e-m.width/2,t,s,n)}function k(i,e,t,s,n,m){~~(.5+Date.now()/s)%2&&T(i,e,t,n,m)}function X(){l.fillStyle="#02ff12",l.fillRect(0,r-30,a,2),M(o.lives+" x ",10,r-7.5,"white",20),l.drawImage(b,o.clipRect.x,o.clipRect.y,o.clipRect.w,o.clipRect.h,45,r-23,o.clipRect.w*.5,o.clipRect.h*.5),M("CREDIT: ",a-115,r-7.5),T("SCORE: "+o.score,a/2,20),k("00",a-25,r-7.5,ae)}function De(i){for(let e=0;e<u.length;e++)u[e].draw(i)}function Ie(i){o.draw(i),De(i),v.draw(),X()}function Se(){T(p.title||"Space Invaders",a/2,r/2.75,"#FFFFFF",36),k("Press enter to play!",a/2,r/2,500,"#FFFFFF",36)}function U(){const i=window.performance.now();let e=i-_;e>100&&(e=100),K(13)&&!d&&(B(),d=!0),d&&Re(e/1e3),l.fillStyle="black",l.fillRect(0,0,a,r),d?Ie(!1):Se(),_=i,requestAnimationFrame(U)}function V(){const i=window.innerWidth,e=window.innerHeight,t=Math.min(i/a,e/r);ne?(A.width=a*t,A.height=r*t,G(!1),l.transform(t,0,0,t,0,0)):(A.style.width=a*t+"px",A.style.height=r*t+"px")}function Pe(i){i.preventDefault(),h[i.keyCode]=!0}function Be(i){i.preventDefault(),h[i.keyCode]=!1}let W;document.addEventListener("touchstart",i=>{W={x:i.touches[0].clientX,y:i.touches[0].clientY},d?o.shoot():(B(),d=!0)}),document.addEventListener("touchmove",i=>{const t={x:i.touches[0].clientX,y:i.touches[0].clientY}.x-W.x;t>0?(h[E]=!0,h[y]=!1):t<0&&(h[y]=!0,h[E]=!1)}),document.addEventListener("touchend",i=>{h[y]=!1,h[E]=!1});const F=document.createElement("link");F.rel="stylesheet",F.href="https://fonts.googleapis.com/css?family=Play:400,700",document.head.appendChild(F),we(),U(),p.autoPlay&&(B(),d=!0);async function R(i){}}
